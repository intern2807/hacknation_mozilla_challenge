<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Chat ‚Äî Web Agent API</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Single page container */
    .page-container {
      max-width: 720px;
      margin: 0 auto;
      padding: var(--demo-space-10) var(--demo-space-6);
    }

    /* Page-specific controls styling */
    .controls {
      margin-top: var(--demo-space-6);
      display: flex;
      gap: var(--demo-space-3);
    }

    .btn {
      flex: 1;
      padding: var(--demo-space-4) var(--demo-space-6);
      border: none;
      border-radius: var(--demo-radius-md);
      font-family: var(--demo-font-sans);
      font-size: var(--demo-text-sm);
      font-weight: var(--demo-weight-semibold);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--demo-space-2);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--demo-accent-primary), var(--demo-accent-secondary));
      color: white;
      box-shadow: var(--demo-shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
      filter: brightness(1.1);
      transform: translateY(-1px);
      box-shadow: var(--demo-shadow-glow);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--demo-bg-surface);
      border: 1px solid var(--demo-border-default);
      color: var(--demo-text-secondary);
    }

    .btn-secondary:hover {
      background: var(--demo-bg-overlay);
      color: var(--demo-text-primary);
    }

    /* Footer */
    .footer {
      margin-top: var(--demo-space-8);
      text-align: center;
      font-size: var(--demo-text-sm);
      color: var(--demo-text-muted);
    }

    .footer a {
      color: var(--demo-text-secondary);
      text-decoration: none;
    }

    .footer a:hover {
      color: var(--demo-accent-primary);
    }

    /* ============================================
       CHAT SECTION (page-specific)
       ============================================ */
    .chat-section {
      display: none;
      margin-top: var(--demo-space-8);
      animation: demo-fadeIn 0.4s ease;
    }

    .chat-section.active {
      display: block;
    }

    .chat-header-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--demo-space-4);
      padding-bottom: var(--demo-space-4);
      border-bottom: 1px solid var(--demo-border-default);
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: var(--demo-space-3);
    }

    .chat-header-logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--demo-accent-primary), var(--demo-accent-tertiary));
      border-radius: var(--demo-radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .chat-header-title {
      font-size: var(--demo-text-lg);
      font-weight: var(--demo-weight-bold);
      color: var(--demo-text-primary);
    }

    .chat-header-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--demo-success);
      color: white;
      border-radius: var(--demo-radius-sm);
      font-weight: var(--demo-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: var(--demo-space-2);
    }

    .chat-header-right {
      display: flex;
      align-items: center;
      gap: var(--demo-space-2);
    }

    /* Status bar */
    .status-bar {
      display: flex;
      align-items: center;
      gap: var(--demo-space-4);
      padding: var(--demo-space-3) var(--demo-space-4);
      background: var(--demo-bg-elevated);
      border: 1px solid var(--demo-border-default);
      border-radius: var(--demo-radius-md);
      margin-bottom: var(--demo-space-4);
      font-size: var(--demo-text-xs);
      color: var(--demo-text-muted);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: var(--demo-space-2);
    }

    /* Messages container */
    .chat-messages {
      background: var(--demo-bg-surface);
      border: 1px solid var(--demo-border-default);
      border-radius: var(--demo-radius-xl);
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      padding: var(--demo-space-4);
    }

    /* Empty state with suggestions */
    .chat-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--demo-space-8) var(--demo-space-4);
      text-align: center;
    }

    .empty-state-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--demo-accent-primary), var(--demo-accent-tertiary));
      border-radius: var(--demo-radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: var(--demo-space-4);
      box-shadow: var(--demo-shadow-glow);
    }

    .empty-state-title {
      font-size: var(--demo-text-lg);
      font-weight: var(--demo-weight-bold);
      color: var(--demo-text-primary);
      margin-bottom: var(--demo-space-2);
    }

    .empty-state-description {
      color: var(--demo-text-secondary);
      max-width: 360px;
      line-height: var(--demo-leading-relaxed);
      margin-bottom: var(--demo-space-5);
      font-size: var(--demo-text-sm);
    }

    .suggestion-prompts {
      display: flex;
      flex-direction: column;
      gap: var(--demo-space-2);
      width: 100%;
      max-width: 360px;
    }

    .suggestion-prompt {
      display: flex;
      align-items: center;
      gap: var(--demo-space-3);
      padding: var(--demo-space-3) var(--demo-space-4);
      background: var(--demo-bg-elevated);
      border: 1px solid var(--demo-border-default);
      border-radius: var(--demo-radius-md);
      color: var(--demo-text-secondary);
      font-size: var(--demo-text-sm);
      cursor: pointer;
      transition: all var(--demo-transition-fast);
      text-align: left;
    }

    .suggestion-prompt:hover {
      background: var(--demo-bg-overlay);
      border-color: var(--demo-accent-primary);
      color: var(--demo-text-primary);
    }

    .suggestion-prompt-icon {
      font-size: var(--demo-text-base);
    }

    /* Tool call content override for larger max-height */
    .tool-call-content {
      max-height: 300px;
    }

    /* No tools warning */
    .no-tools-warning {
      background: var(--demo-warning-dim);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--demo-radius-md);
      padding: var(--demo-space-4);
      margin-bottom: var(--demo-space-4);
    }

    .no-tools-warning-title {
      display: flex;
      align-items: center;
      gap: var(--demo-space-2);
      font-size: var(--demo-text-sm);
      font-weight: var(--demo-weight-semibold);
      color: var(--demo-warning);
      margin-bottom: var(--demo-space-2);
    }

    .no-tools-warning-text {
      font-size: var(--demo-text-sm);
      color: var(--demo-text-secondary);
      line-height: var(--demo-leading-relaxed);
    }

    .no-tools-warning-text a {
      color: var(--demo-warning);
    }

    /* Debug panel */
    .debug-panel {
      margin-top: var(--demo-space-4);
      background: var(--demo-bg-base);
      border: 1px solid var(--demo-border-default);
      border-radius: var(--demo-radius-md);
      overflow: hidden;
    }

    .debug-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--demo-space-2) var(--demo-space-3);
      background: var(--demo-bg-elevated);
      border-bottom: 1px solid var(--demo-border-default);
      font-size: var(--demo-text-xs);
      color: var(--demo-text-muted);
      cursor: pointer;
    }

    .debug-content {
      padding: var(--demo-space-3);
      font-family: var(--demo-font-mono);
      font-size: 10px;
      color: var(--demo-text-secondary);
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .debug-content.collapsed {
      display: none;
    }
  </style>
</head>
<body class="demo-bg-grid">
  <div class="page-container">
    <!-- ============================================
         HEADER
         ============================================ -->
    <header class="demo-header">
      <div class="header-badge">
        <span class="dot"></span>
        <span>Email Setup Wizard</span>
      </div>
      <h1 class="demo-title demo-text-gradient">Chat with Your Email</h1>
      <p class="demo-subtitle">Let's set up the Web Agent API with Gmail tools so you can chat with your inbox.</p>
    </header>

    <!-- ============================================
         SETUP STEPS
         ============================================ -->
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>

    <div class="checklist" id="checklist">
      <div class="step waiting" data-step="0">
        <div class="step-icon">1</div>
        <div class="step-content">
          <div class="step-title">Detect Web Agent API</div>
          <div class="step-description">Check if a Web Agent API implementation is available</div>
          <pre class="step-code"><span class="comment">// Check for Web Agent API availability</span>
<span class="keyword">if</span> (window.<span class="property">ai</span> && window.<span class="property">agent</span>) {
  console.<span class="method">log</span>(<span class="string">'Web Agent API is ready!'</span>);
}</pre>
        </div>
      </div>

      <div class="step waiting" data-step="1">
        <div class="step-icon">2</div>
        <div class="step-content">
          <div class="step-title">Request Permissions</div>
          <div class="step-description">Get access to the AI model and MCP tools</div>
          <pre class="step-code"><span class="keyword">const</span> result = <span class="keyword">await</span> window.<span class="property">agent</span>.<span class="method">requestPermissions</span>({
  <span class="property">scopes</span>: [
    <span class="string">'model:prompt'</span>,
    <span class="string">'model:tools'</span>,
    <span class="string">'mcp:tools.list'</span>,
    <span class="string">'mcp:tools.call'</span>
  ],
  <span class="property">reason</span>: <span class="string">'Chat with your email inbox'</span>
});</pre>
        </div>
      </div>

      <div class="step waiting" data-step="2">
        <div class="step-icon">3</div>
        <div class="step-content">
          <div class="step-title">Check LLM Availability</div>
          <div class="step-description">Verify that an AI model is configured and responding</div>
          <pre class="step-code"><span class="comment">// Create a test session to verify LLM works</span>
<span class="keyword">const</span> session = <span class="keyword">await</span> window.<span class="property">ai</span>.<span class="method">createTextSession</span>();
<span class="keyword">await</span> session.<span class="method">destroy</span>();
console.<span class="method">log</span>(<span class="string">'LLM is ready!'</span>);</pre>
        </div>
      </div>

      <div class="step waiting" data-step="3">
        <div class="step-icon">4</div>
        <div class="step-content">
          <div class="step-title">Find Email Tools</div>
          <div class="step-description">Check for Gmail or email-related MCP tools</div>
          <pre class="step-code"><span class="keyword">const</span> tools = <span class="keyword">await</span> window.<span class="property">agent</span>.<span class="property">tools</span>.<span class="method">list</span>();
<span class="keyword">const</span> emailTools = tools.<span class="method">filter</span>(t => 
  t.<span class="property">name</span>.<span class="method">includes</span>(<span class="string">'gmail'</span>) || 
  t.<span class="property">name</span>.<span class="method">includes</span>(<span class="string">'email'</span>) ||
  t.<span class="property">name</span>.<span class="method">includes</span>(<span class="string">'mail'</span>)
);
console.<span class="method">log</span>(<span class="string">`Found ${emailTools.length} email tools`</span>);</pre>
        </div>
      </div>

      <div class="step waiting" data-step="4">
        <div class="step-icon">5</div>
        <div class="step-content">
          <div class="step-title">Ready to Chat!</div>
          <div class="step-description">Everything is set up ‚Äî scroll down to start chatting with your email</div>
          <pre class="step-code"><span class="comment">// Launch the email chat interface</span>
<span class="keyword">for await</span> (<span class="keyword">const</span> event <span class="keyword">of</span> window.<span class="property">agent</span>.<span class="method">run</span>({
  <span class="property">task</span>: <span class="string">'Summarize my recent unread emails'</span>,
  <span class="property">maxToolCalls</span>: <span class="number">10</span>
})) {
  console.<span class="method">log</span>(event);
}</pre>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-secondary" id="reset-btn" style="display: none;">
        ‚Ü∫ Start Over
      </button>
      <button class="btn btn-primary" id="next-btn">
        Run Step 1 ‚Üí
      </button>
    </div>

    <!-- ============================================
         CHAT SECTION (appears below after setup)
         ============================================ -->
    <div class="chat-section" id="chat-section">
      <div class="chat-header-inline">
        <div class="chat-header-left">
          <div class="chat-header-logo">üìß</div>
          <div>
            <span class="chat-header-title">Email Chat</span>
            <span class="chat-header-badge">Ready</span>
          </div>
        </div>
        <div class="chat-header-right">
          <button class="icon-btn" id="clear-chat-btn" title="Clear chat">üóë</button>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <span class="demo-status-dot success"></span>
          <span>Web Agent API</span>
        </div>
        <div class="status-item">
          <span class="demo-status-dot success"></span>
          <span>LLM Ready</span>
        </div>
        <div class="status-item">
          <span class="demo-status-dot" id="email-tools-status"></span>
          <span id="email-tools-text">Email Tools: ‚Äî</span>
        </div>
      </div>

      <div id="no-tools-warning" style="display: none;">
        <div class="no-tools-warning">
          <div class="no-tools-warning-title">
            <span>‚ö†Ô∏è</span>
            <span>No Email Tools Found</span>
          </div>
          <p class="no-tools-warning-text">
            To interact with your email, you'll need a Gmail MCP server running. 
            Check out <a href="https://github.com/anthropics/mcp" target="_blank">MCP servers</a> 
            for Gmail integration options.
          </p>
        </div>
      </div>

      <div class="chat-messages" id="chat-messages">
        <!-- Empty state shown initially -->
        <div class="chat-empty-state" id="chat-empty-state">
          <div class="empty-state-icon">üìß</div>
          <h2 class="empty-state-title">Ready to Chat</h2>
          <p class="empty-state-description">
            Ask questions about your inbox, search for emails, draft replies, or get summaries.
          </p>
          
          <div class="suggestion-prompts">
            <button class="suggestion-prompt" data-prompt="Summarize my unread emails from today">
              <span class="suggestion-prompt-icon">üì¨</span>
              <span>Summarize my unread emails from today</span>
            </button>
            <button class="suggestion-prompt" data-prompt="Find emails from my manager this week">
              <span class="suggestion-prompt-icon">üîç</span>
              <span>Find emails from my manager this week</span>
            </button>
            <button class="suggestion-prompt" data-prompt="Draft a reply to my most recent email">
              <span class="suggestion-prompt-icon">‚úèÔ∏è</span>
              <span>Draft a reply to my most recent email</span>
            </button>
          </div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="input-wrapper">
          <textarea 
            id="message-input" 
            placeholder="Ask about your emails..."
            rows="1"
          ></textarea>
          <button class="send-btn" id="send-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Debug panel for tool results -->
      <div class="debug-panel" id="debug-panel">
        <div class="debug-header" onclick="document.getElementById('debug-content').classList.toggle('collapsed')">
          <span>üîß Debug: Tool Events</span>
          <span>‚ñº</span>
        </div>
        <div class="debug-content" id="debug-content"></div>
      </div>
    </div>

    <footer class="footer">
      <a href="../">‚Üê Back to Demos</a>
    </footer>
  </div>

  <script>
    // =============================================================================
    // State
    // =============================================================================
    let emailTools = [];
    let allTools = [];
    let messages = [];
    let isProcessing = false;
    let debugLog = [];

    // =============================================================================
    // Debug Logging
    // =============================================================================
    function logDebug(type, data) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const entry = `[${timestamp}] ${type}: ${JSON.stringify(data, null, 2)}`;
      debugLog.push(entry);
      
      const debugContent = document.getElementById('debug-content');
      debugContent.textContent = debugLog.join('\n\n');
      debugContent.scrollTop = debugContent.scrollHeight;
      
      // Also log to console for easier debugging
      console.log(`[Email Chat Debug] ${type}:`, data);
    }

    // =============================================================================
    // SETUP PHASE LOGIC
    // =============================================================================
    const steps = [
      {
        title: 'Detect Web Agent API',
        run: async () => {
          await delay(500);
          if (!window.ai || !window.agent) {
            throw new Error('Web Agent API not detected.\n\nMake sure:\n‚Ä¢ A Web Agent API implementation is installed\n‚Ä¢ This page is allowed access');
          }
          return '‚úì window.ai\n‚úì window.agent';
        }
      },
      {
        title: 'Request Permissions',
        run: async () => {
          const result = await window.agent.requestPermissions({
            scopes: ['model:prompt', 'model:tools', 'mcp:tools.list', 'mcp:tools.call'],
            reason: 'Chat with your email inbox using AI'
          });
          
          if (!result.granted) {
            throw new Error('Permission denied by user');
          }
          return '‚úì Permission granted';
        }
      },
      {
        title: 'Check LLM Availability',
        run: async () => {
          try {
            const testSession = await window.ai.createTextSession();
            await testSession.destroy();
            return '‚úì LLM is ready and responding';
          } catch (err) {
            throw new Error('LLM not available.\n\nMake sure an LLM provider is configured and running.');
          }
        }
      },
      {
        title: 'Find Email Tools',
        run: async () => {
          const tools = await window.agent.tools.list();
          allTools = tools;
          
          // Filter for email-related tools
          emailTools = tools.filter(t => {
            const name = t.name.toLowerCase();
            const desc = (t.description || '').toLowerCase();
            return name.includes('gmail') || 
                   name.includes('email') || 
                   name.includes('mail') ||
                   desc.includes('gmail') ||
                   desc.includes('email');
          });
          
          let output = `Found ${tools.length} total tool${tools.length === 1 ? '' : 's'}\n`;
          
          if (emailTools.length > 0) {
            output += `\nüìß Email tools (${emailTools.length}):\n`;
            output += emailTools.slice(0, 5).map(t => `  ‚Ä¢ ${t.name}`).join('\n');
            if (emailTools.length > 5) {
              output += `\n  ... and ${emailTools.length - 5} more`;
            }
          } else {
            output += '\n‚ö†Ô∏è No email-specific tools found.\nYou can still chat, but email features require a Gmail MCP server.';
          }
          
          return output;
        }
      },
      {
        title: 'Ready to Chat!',
        run: async () => {
          await delay(300);
          return '‚úì Setup complete!\n\nScroll down to start chatting with your email.';
        }
      }
    ];

    let currentStep = -1;
    const totalSteps = steps.length;

    // DOM Elements - Setup
    const nextBtn = document.getElementById('next-btn');
    const resetBtn = document.getElementById('reset-btn');
    const progressFill = document.getElementById('progress-fill');
    const checklist = document.getElementById('checklist');
    const chatSection = document.getElementById('chat-section');

    // DOM Elements - Chat
    const chatMessages = document.getElementById('chat-messages');
    const chatEmptyState = document.getElementById('chat-empty-state');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const emailToolsStatus = document.getElementById('email-tools-status');
    const emailToolsText = document.getElementById('email-tools-text');
    const noToolsWarning = document.getElementById('no-tools-warning');

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateProgress() {
      const percent = ((currentStep + 1) / totalSteps) * 100;
      progressFill.style.width = `${percent}%`;
    }

    function getStepElement(index) {
      return checklist.querySelector(`[data-step="${index}"]`);
    }

    function setStepState(index, state, output = null) {
      const el = getStepElement(index);
      el.className = `step ${state}`;
      
      const icon = el.querySelector('.step-icon');
      if (state === 'completed') {
        icon.textContent = '‚úì';
      } else if (state === 'error') {
        icon.textContent = '‚úó';
      } else if (state === 'active') {
        icon.innerHTML = '<div class="spinner"></div>';
      } else {
        icon.textContent = index + 1;
      }

      // Remove existing output
      const existingOutput = el.querySelector('.step-output');
      const existingLabel = el.querySelector('.output-label');
      if (existingOutput) existingOutput.remove();
      if (existingLabel) existingLabel.remove();

      // Add new output if provided
      if (output) {
        const labelEl = document.createElement('div');
        labelEl.className = 'output-label';
        labelEl.textContent = state === 'error' ? '‚úó Error' : '‚Üí Output';
        
        const outputEl = document.createElement('div');
        outputEl.className = `step-output ${state === 'error' ? 'error' : 'success'}`;
        outputEl.textContent = output;
        
        el.querySelector('.step-content').appendChild(labelEl);
        el.querySelector('.step-content').appendChild(outputEl);
      }
    }

    async function runStep(index) {
      const step = steps[index];
      setStepState(index, 'active');
      
      try {
        const result = await step.run();
        setStepState(index, 'completed', result);
        return true;
      } catch (err) {
        setStepState(index, 'error', err.message);
        return false;
      }
    }

    async function next() {
      if (currentStep >= totalSteps - 1) {
        return;
      }

      currentStep++;
      updateProgress();

      nextBtn.disabled = true;
      nextBtn.innerHTML = '<div class="spinner"></div> Running...';

      const success = await runStep(currentStep);

      if (success && currentStep < totalSteps - 1) {
        nextBtn.disabled = false;
        nextBtn.textContent = `Run Step ${currentStep + 2} ‚Üí`;
      } else if (success && currentStep === totalSteps - 1) {
        // All steps complete - show chat section below
        nextBtn.disabled = true;
        nextBtn.textContent = 'Complete! ‚úì';
        nextBtn.style.background = 'var(--demo-success)';
        resetBtn.style.display = 'block';
        
        // Show chat section and scroll to it
        showChatSection();
      } else {
        // Error occurred
        nextBtn.disabled = false;
        nextBtn.textContent = 'Retry ‚Üí';
        currentStep--; // Allow retry
        resetBtn.style.display = 'block';
      }
    }

    function reset() {
      currentStep = -1;
      updateProgress();
      
      // Reset all steps
      for (let i = 0; i < totalSteps; i++) {
        const el = getStepElement(i);
        el.className = 'step waiting';
        el.querySelector('.step-icon').textContent = i + 1;
        const output = el.querySelector('.step-output');
        const label = el.querySelector('.output-label');
        if (output) output.remove();
        if (label) label.remove();
      }

      nextBtn.disabled = false;
      nextBtn.textContent = 'Run Step 1 ‚Üí';
      nextBtn.style.background = '';
      resetBtn.style.display = 'none';
      
      // Hide chat section
      chatSection.classList.remove('active');
    }

    nextBtn.addEventListener('click', next);
    resetBtn.addEventListener('click', reset);

    // =============================================================================
    // CHAT PHASE LOGIC
    // =============================================================================

    function showChatSection() {
      chatSection.classList.add('active');
      
      // Update status bar
      if (emailTools.length > 0) {
        emailToolsStatus.classList.add('success');
        emailToolsText.textContent = `Email Tools: ${emailTools.length}`;
      } else {
        emailToolsStatus.classList.add('warning');
        emailToolsText.textContent = 'Email Tools: None';
        noToolsWarning.style.display = 'block';
      }
      
      // Scroll to chat section
      setTimeout(() => {
        chatSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function hideEmptyState() {
      chatEmptyState.style.display = 'none';
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessageUI(role, content) {
      hideEmptyState();
      messages.push({ role, content });
      
      const messageEl = document.createElement('div');
      messageEl.className = `message ${role}`;
      
      const avatar = role === 'user' ? 'U' : 'A';
      const roleName = role === 'user' ? 'You' : 'Email Assistant';
      
      const bodyHtml = content.split('\n').map(line => `<p>${escapeHtml(line) || '&nbsp;'}</p>`).join('');
      
      messageEl.innerHTML = `
        <div class="message-header">
          <div class="message-avatar">${avatar}</div>
          <span class="message-role">${roleName}</span>
          <span class="message-time">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="message-body">${bodyHtml}</div>
      `;
      
      chatMessages.appendChild(messageEl);
      scrollToBottom();
      
      return messageEl;
    }

    function addToolCallUI(name, args, status, result) {
      const toolEl = document.createElement('div');
      toolEl.className = 'tool-call';
      
      const statusIcon = status === 'pending' ? '‚è≥' : status === 'success' ? '‚úì' : '‚úï';
      const argsStr = JSON.stringify(args, null, 2);
      
      let resultSection = '';
      if (result !== undefined) {
        const resultStr = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
        resultSection = `\n\nResult:\n${resultStr}`;
      }
      
      toolEl.innerHTML = `
        <div class="tool-call-header" onclick="this.nextElementSibling.classList.toggle('collapsed')">
          <span>üîß</span>
          <span class="tool-call-name">${escapeHtml(name)}</span>
          <span class="tool-call-status ${status}">${statusIcon} ${status}</span>
        </div>
        <div class="tool-call-content">Args:\n${escapeHtml(argsStr)}${resultSection ? escapeHtml(resultSection) : ''}</div>
      `;
      
      chatMessages.appendChild(toolEl);
      scrollToBottom();
      
      return toolEl;
    }

    function updateToolCallUI(toolEl, status, result) {
      const statusEl = toolEl.querySelector('.tool-call-status');
      const contentEl = toolEl.querySelector('.tool-call-content');
      
      const statusIcon = status === 'success' ? '‚úì' : '‚úï';
      statusEl.className = `tool-call-status ${status}`;
      statusEl.textContent = `${statusIcon} ${status}`;
      
      // Format result - show even if null/undefined for debugging
      let resultStr;
      if (result === undefined) {
        resultStr = '(undefined)';
      } else if (result === null) {
        resultStr = '(null)';
      } else if (typeof result === 'string') {
        resultStr = result || '(empty string)';
      } else {
        resultStr = JSON.stringify(result, null, 2) || '(empty)';
      }
      
      contentEl.textContent += '\n\nResult:\n' + resultStr;
    }

    function addThinkingUI(initialText = 'Thinking...') {
      hideEmptyState();
      
      // Remove any existing thinking indicator
      removeThinking();
      
      const thinkingEl = document.createElement('div');
      thinkingEl.className = 'message assistant';
      thinkingEl.id = 'thinking';
      thinkingEl.innerHTML = `
        <div class="message-header">
          <div class="message-avatar">A</div>
          <span class="message-role">Email Assistant</span>
        </div>
        <div class="message-body">
          <div class="thinking">
            <div class="thinking-dots"><span></span><span></span><span></span></div>
            <span id="thinking-text">${initialText}</span>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(thinkingEl);
      scrollToBottom();
      
      return thinkingEl;
    }

    function updateThinkingText(text) {
      const el = document.getElementById('thinking-text');
      if (el) {
        el.innerHTML = '';
        el.textContent = text;
      }
    }

    function removeThinking() {
      const el = document.getElementById('thinking');
      if (el) el.remove();
    }

    function clearChat() {
      messages.length = 0;
      debugLog.length = 0;
      
      // Clear messages but keep empty state
      chatMessages.innerHTML = '';
      chatMessages.appendChild(chatEmptyState);
      chatEmptyState.style.display = 'flex';
      
      // Clear debug panel
      document.getElementById('debug-content').textContent = '';
    }

    async function sendMessage(content) {
      if (!content.trim() || isProcessing) return;
      
      isProcessing = true;
      sendBtn.disabled = true;
      messageInput.value = '';
      autoResizeInput();
      
      addMessageUI('user', content);
      addThinkingUI('Connecting to email...');
      
      logDebug('SEND_MESSAGE', { task: content });
      
      try {
        let responseText = '';
        let messageEl = null;
        const toolElements = new Map();
        
        // Use agent.run with tool access
        for await (const event of window.agent.run({ 
          task: content, 
          maxToolCalls: 10,
        })) {
          // Log every event for debugging
          logDebug('EVENT', event);
          
          switch (event.type) {
            case 'status':
              updateThinkingText(event.message);
              break;
              
            case 'tool_call':
              removeThinking();
              logDebug('TOOL_CALL', { tool: event.tool, args: event.args });
              const toolEl = addToolCallUI(event.tool, event.args, 'pending');
              toolElements.set(event.tool, toolEl);
              addThinkingUI('Waiting for tool result...');
              break;
              
            case 'tool_result':
              logDebug('TOOL_RESULT', { 
                tool: event.tool, 
                result: event.result,
                resultType: typeof event.result,
                error: event.error 
              });
              const el = toolElements.get(event.tool);
              if (el) {
                updateToolCallUI(el, event.error ? 'error' : 'success', event.result);
              }
              break;
              
            case 'token':
              if (event.token) {
                responseText += event.token;
                
                if (!messageEl) {
                  removeThinking();
                  messageEl = addMessageUI('assistant', responseText);
                } else {
                  const body = messageEl.querySelector('.message-body');
                  if (body) {
                    body.innerHTML = responseText.split('\n').map(line => `<p>${escapeHtml(line) || '&nbsp;'}</p>`).join('');
                  }
                }
                scrollToBottom();
              }
              break;
              
            case 'final':
              logDebug('FINAL', { output: event.output, responseTextLength: responseText.length });
              removeThinking();
              const finalText = event.output || responseText || '';
              
              if (finalText) {
                if (!messageEl) {
                  messageEl = addMessageUI('assistant', finalText);
                } else {
                  const body = messageEl.querySelector('.message-body');
                  if (body) {
                    body.innerHTML = finalText.split('\n').map(line => `<p>${escapeHtml(line) || '&nbsp;'}</p>`).join('');
                  }
                }
              } else if (!messageEl) {
                messageEl = addMessageUI('assistant', '(No response)');
              }
              break;
              
            case 'error':
              logDebug('ERROR', event.error);
              removeThinking();
              addMessageUI('assistant', `Error: ${event.error.message}`);
              break;
          }
        }
        
        removeThinking();
      } catch (err) {
        logDebug('EXCEPTION', { message: err.message, stack: err.stack });
        removeThinking();
        addMessageUI('assistant', `Error: ${err.message}`);
      }
      
      isProcessing = false;
      sendBtn.disabled = false;
    }

    function autoResizeInput() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
    }

    // Event Listeners - Chat
    messageInput.addEventListener('input', autoResizeInput);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(messageInput.value);
      }
    });

    sendBtn.addEventListener('click', () => {
      sendMessage(messageInput.value);
    });

    clearChatBtn.addEventListener('click', clearChat);

    // Suggestion prompts
    document.querySelectorAll('.suggestion-prompt').forEach(btn => {
      btn.addEventListener('click', () => {
        const prompt = btn.getAttribute('data-prompt');
        sendMessage(prompt);
      });
    });

    // =============================================================================
    // Initialize
    // =============================================================================
    console.log('[Email Chat Demo] Ready');
    console.log('  window.ai:', typeof window.ai !== 'undefined' ? '‚úì' : '‚úï');
    console.log('  window.agent:', typeof window.agent !== 'undefined' ? '‚úì' : '‚úï');
  </script>
</body>
</html>
