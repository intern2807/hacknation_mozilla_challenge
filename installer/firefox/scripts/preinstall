#!/bin/bash
# Harbor Installer - Pre-install checks
# This script runs before installation to verify requirements

set -e

LOG_FILE="/tmp/harbor-install.log"
echo "Harbor pre-install check started at $(date)" >> "$LOG_FILE"

# =============================================================================
# Check 0: Architecture Compatibility
# =============================================================================
check_architecture() {
    CURRENT_ARCH=$(uname -m)
    # This marker is set during build - will be replaced by build script
    BUILT_FOR_ARCH="__BUILD_ARCH__"
    
    echo -n "Checking architecture... "
    
    # If marker wasn't replaced, assume it matches (universal or dev build)
    if [ "$BUILT_FOR_ARCH" = "__BUILD_ARCH__" ]; then
        echo "âœ“ (universal or dev build)"
        return 0
    fi
    
    # Check if we're running on a compatible architecture
    if [ "$BUILT_FOR_ARCH" = "universal" ]; then
        echo "âœ“ Universal binary (works on Intel and Apple Silicon)"
        return 0
    fi
    
    if [ "$CURRENT_ARCH" = "$BUILT_FOR_ARCH" ]; then
        echo "âœ“ $CURRENT_ARCH"
        return 0
    fi
    
    # Architecture mismatch!
    echo "âœ— INCOMPATIBLE"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  âŒ Architecture Mismatch!"
    echo ""
    echo "  This installer was built for: $BUILT_FOR_ARCH"
    echo "  Your Mac is running: $CURRENT_ARCH"
    echo ""
    if [ "$CURRENT_ARCH" = "x86_64" ]; then
        echo "  You have an Intel Mac, but this installer is for Apple Silicon."
    else
        echo "  You have an Apple Silicon Mac, but this installer is for Intel."
    fi
    echo ""
    echo "  Please download the correct installer for your Mac."
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    echo "Architecture mismatch: built for $BUILT_FOR_ARCH, running on $CURRENT_ARCH" >> "$LOG_FILE"
    exit 1
}

# =============================================================================
# Check 1: Firefox (REQUIRED)
# =============================================================================
check_firefox() {
    echo -n "Checking for Firefox... "
    
    # Check for Firefox.app in Applications
    if [ -d "/Applications/Firefox.app" ]; then
        FIREFOX_VERSION=$(/Applications/Firefox.app/Contents/MacOS/firefox --version 2>/dev/null | head -1 || echo "unknown")
        echo "âœ“ Found: $FIREFOX_VERSION"
        echo "Firefox found: $FIREFOX_VERSION" >> "$LOG_FILE"
        return 0
    fi
    
    # Check for Firefox in user Applications
    if [ -d "$HOME/Applications/Firefox.app" ]; then
        FIREFOX_VERSION=$("$HOME/Applications/Firefox.app/Contents/MacOS/firefox" --version 2>/dev/null | head -1 || echo "unknown")
        echo "âœ“ Found: $FIREFOX_VERSION"
        echo "Firefox found (user): $FIREFOX_VERSION" >> "$LOG_FILE"
        return 0
    fi
    
    # Check if firefox is in PATH (e.g., installed via Homebrew)
    if command -v firefox &> /dev/null; then
        FIREFOX_VERSION=$(firefox --version 2>/dev/null | head -1 || echo "unknown")
        echo "âœ“ Found: $FIREFOX_VERSION"
        echo "Firefox found (PATH): $FIREFOX_VERSION" >> "$LOG_FILE"
        return 0
    fi
    
    echo "âœ— NOT FOUND"
    echo "Firefox NOT found" >> "$LOG_FILE"
    return 1
}

# =============================================================================
# Check 2: Docker (RECOMMENDED)
# =============================================================================
check_docker() {
    echo -n "Checking for Docker... "
    
    # Check for Docker Desktop
    if [ -d "/Applications/Docker.app" ]; then
        echo "âœ“ Found: Docker Desktop"
        echo "Docker Desktop found" >> "$LOG_FILE"
        
        # Check if Docker daemon is running (quick socket check)
        if [ -S /var/run/docker.sock ] || [ -S "$HOME/.docker/run/docker.sock" ]; then
            echo "  â””â”€ Docker daemon appears to be running âœ“"
            return 0
        else
            echo "  â””â”€ âš  Docker Desktop installed but not running"
            echo "Docker not running" >> "$LOG_FILE"
            return 2  # Installed but not running
        fi
    fi
    
    # Check for docker CLI (could be installed via Homebrew, Colima, etc.)
    if command -v docker &> /dev/null; then
        DOCKER_VERSION=$(docker --version 2>/dev/null || echo "unknown")
        echo "âœ“ Found: $DOCKER_VERSION"
        echo "Docker CLI found: $DOCKER_VERSION" >> "$LOG_FILE"
        
        # Check if daemon is running (quick socket check)
        if [ -S /var/run/docker.sock ] || [ -S "$HOME/.docker/run/docker.sock" ]; then
            echo "  â””â”€ Docker daemon appears to be running âœ“"
            return 0
        else
            echo "  â””â”€ âš  Docker CLI found but daemon not running"
            return 2
        fi
    fi
    
    # Check for Podman as alternative
    if command -v podman &> /dev/null; then
        PODMAN_VERSION=$(podman --version 2>/dev/null || echo "unknown")
        echo "âœ“ Found: Podman ($PODMAN_VERSION)"
        echo "Podman found: $PODMAN_VERSION" >> "$LOG_FILE"
        return 0
    fi
    
    echo "âœ— NOT FOUND"
    echo "Docker NOT found" >> "$LOG_FILE"
    return 1
}

# =============================================================================
# Check 3: Python (OPTIONAL - for Python MCP servers)
# =============================================================================
check_python() {
    echo -n "Checking for Python... "
    
    # Check for python3 first (preferred)
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version 2>/dev/null || echo "unknown")
        echo "âœ“ Found: $PYTHON_VERSION"
        echo "Python found: $PYTHON_VERSION" >> "$LOG_FILE"
        
        # Check for uvx (preferred package runner)
        if command -v uvx &> /dev/null; then
            UVX_VERSION=$(uvx --version 2>/dev/null || echo "unknown")
            echo "  â””â”€ uvx available âœ“ ($UVX_VERSION)"
        elif command -v pipx &> /dev/null; then
            echo "  â””â”€ pipx available âœ“"
        fi
        return 0
    fi
    
    # Fall back to python
    if command -v python &> /dev/null; then
        PYTHON_VERSION=$(python --version 2>/dev/null || echo "unknown")
        # Make sure it's not Python 2
        if [[ "$PYTHON_VERSION" == *"Python 3"* ]]; then
            echo "âœ“ Found: $PYTHON_VERSION"
            echo "Python found: $PYTHON_VERSION" >> "$LOG_FILE"
            return 0
        fi
    fi
    
    echo "âœ— NOT FOUND"
    echo "Python NOT found" >> "$LOG_FILE"
    return 1
}

# =============================================================================
# Check 4: Node.js/npm (OPTIONAL - for Node.js MCP servers)
# =============================================================================
check_node() {
    echo -n "Checking for Node.js... "
    
    # Check for node
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node --version 2>/dev/null || echo "unknown")
        echo "âœ“ Found: $NODE_VERSION"
        echo "Node.js found: $NODE_VERSION" >> "$LOG_FILE"
        
        # Check for npx
        if command -v npx &> /dev/null; then
            echo "  â””â”€ npx available âœ“"
        fi
        return 0
    fi
    
    echo "âœ— NOT FOUND"
    echo "Node.js NOT found" >> "$LOG_FILE"
    return 1
}

# =============================================================================
# Check 5: Existing Harbor Installation
# =============================================================================
check_existing_install() {
    echo -n "Checking for existing Harbor installation... "
    
    EXISTING=0
    EXISTING_VERSION=""
    
    # Check for Harbor directory
    if [ -d "/Library/Application Support/Harbor" ]; then
        EXISTING=1
        # Try to get version from the bridge
        if [ -f "/Library/Application Support/Harbor/harbor-bridge" ]; then
            # Could potentially query version, for now just note it exists
            EXISTING_VERSION="(version unknown)"
        fi
    fi
    
    # Check for native messaging manifest
    if [ -f "/Library/Application Support/Mozilla/NativeMessagingHosts/harbor_bridge_host.json" ]; then
        EXISTING=1
    fi
    
    # Check for Firefox policy
    if [ -f "/Library/Application Support/Mozilla/policies/policies.json" ]; then
        if grep -q "harbor" "/Library/Application Support/Mozilla/policies/policies.json" 2>/dev/null; then
            EXISTING=1
        fi
    fi
    
    if [ $EXISTING -eq 1 ]; then
        echo "âœ“ Found existing installation $EXISTING_VERSION"
        echo "Existing Harbor installation found" >> "$LOG_FILE"
        return 0
    else
        echo "âœ“ No existing installation (fresh install)"
        echo "No existing installation" >> "$LOG_FILE"
        return 1
    fi
}

# =============================================================================
# Display Results
# =============================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Harbor Installer - System Requirements Check"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check architecture first (exits if incompatible)
check_architecture

echo ""

FIREFOX_OK=0
DOCKER_OK=0
PYTHON_OK=0
NODE_OK=0
DOCKER_WARNING=""
UPGRADE_MODE=0

# Check Firefox (REQUIRED)
if check_firefox; then
    FIREFOX_OK=1
fi

echo ""

# Check Docker (recommended)
check_docker
DOCKER_STATUS=$?
if [ $DOCKER_STATUS -eq 0 ]; then
    DOCKER_OK=1
elif [ $DOCKER_STATUS -eq 2 ]; then
    DOCKER_WARNING="Docker is installed but not running. Please start Docker Desktop before using Harbor."
fi

echo ""

# Check Python (optional)
if check_python; then
    PYTHON_OK=1
fi

echo ""

# Check Node.js (optional)
if check_node; then
    NODE_OK=1
fi

echo ""

# Check for existing installation
if check_existing_install; then
    UPGRADE_MODE=1
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# =============================================================================
# Handle Results
# =============================================================================

# Firefox is required - block if not found
if [ $FIREFOX_OK -eq 0 ]; then
    echo "âŒ Firefox is required to use Harbor."
    echo ""
    echo "   Please install Firefox first:"
    echo "   https://www.mozilla.org/firefox/"
    echo ""
    echo "   Installation cannot continue without Firefox."
    echo ""
    echo "Firefox required but not found - blocking install" >> "$LOG_FILE"
    exit 1
fi

# Docker warning (but allow continue)
if [ $DOCKER_OK -eq 0 ]; then
    echo "âš ï¸  Docker is recommended for running MCP servers."
    echo ""
    echo "   Harbor will install, but you'll need Docker to use MCP tools."
    echo "   Install Docker Desktop from: https://www.docker.com/products/docker-desktop/"
    echo ""
elif [ -n "$DOCKER_WARNING" ]; then
    echo "âš ï¸  $DOCKER_WARNING"
    echo ""
fi

# =============================================================================
# Runtime Capabilities Summary
# =============================================================================

echo "ðŸ“¦ Runtime Capabilities:"
echo ""

# Explain what each runtime enables
if [ $DOCKER_OK -eq 1 ]; then
    echo "   âœ“ Docker: Can run ANY MCP server (sandboxed, secure)"
else
    echo "   âœ— Docker: Cannot run servers with native dependencies"
fi

if [ $PYTHON_OK -eq 1 ]; then
    echo "   âœ“ Python: Can run Python MCP servers natively"
else
    echo "   âœ— Python: Cannot run Python servers (need Docker or Python 3)"
fi

if [ $NODE_OK -eq 1 ]; then
    echo "   âœ“ Node.js: Can run JavaScript MCP servers natively"
else
    echo "   âœ— Node.js: Cannot run JS servers natively (but bridge is bundled)"
fi

echo ""

# Note: Harbor bundles Node.js in the bridge binary
echo "   â„¹ï¸  Note: Harbor's bridge includes bundled Node.js for core functionality."
echo "      External Node.js is optional but enables native npx execution."
echo ""

# Upgrade mode notification
if [ $UPGRADE_MODE -eq 1 ]; then
    echo "â„¹ï¸  An existing Harbor installation was detected."
    echo "   This installer will upgrade your installation."
    echo "   Your settings and data in ~/.harbor/ will be preserved."
    echo ""
fi

echo "Proceeding with installation..."
echo ""

echo "Pre-install checks passed at $(date)" >> "$LOG_FILE"
exit 0
