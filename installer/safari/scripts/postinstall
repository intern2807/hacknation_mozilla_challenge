#!/bin/bash
# Harbor Safari - Post-install script
# Opens the app and provides setup guidance

set -e

LOG_FILE="/tmp/harbor-safari-install.log"
echo "Harbor Safari post-install started at $(date)" >> "$LOG_FILE"

# =============================================================================
# Get actual user (not root from sudo)
# =============================================================================

ACTUAL_USER="${SUDO_USER:-}"
if [ -z "$ACTUAL_USER" ]; then
    # Try to get the console user (logged in at GUI)
    ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
fi

echo "Detected user: $ACTUAL_USER" >> "$LOG_FILE"

# =============================================================================
# Create first-run marker
# =============================================================================

if [ -n "$ACTUAL_USER" ] && [ "$ACTUAL_USER" != "root" ]; then
    USER_HOME=$(eval echo "~$ACTUAL_USER")
    HARBOR_DIR="$USER_HOME/.harbor"
    
    # Create harbor config directory as user
    su "$ACTUAL_USER" -c "mkdir -p '$HARBOR_DIR'" 2>/dev/null || true
    
    # Create first-run marker (only if doesn't exist - preserves on upgrade)
    if [ ! -f "$HARBOR_DIR/.installed-safari" ]; then
        su "$ACTUAL_USER" -c "cat > '$HARBOR_DIR/.installed-safari'" << EOF
installed=$(date +%s)
version=${VERSION:-unknown}
browser=safari
show_welcome=true
EOF
        echo "First-run marker created" >> "$LOG_FILE"
    fi
fi

# =============================================================================
# Launch Harbor app
# =============================================================================

echo "Launching Harbor app..." >> "$LOG_FILE"

if [ -n "$ACTUAL_USER" ] && [ "$ACTUAL_USER" != "root" ]; then
    # Open the Harbor app as the actual user
    # This will show the main window with setup instructions
    su "$ACTUAL_USER" -c "open -a Harbor" 2>> "$LOG_FILE" &
    echo "Harbor app launched for $ACTUAL_USER" >> "$LOG_FILE"
else
    echo "Could not launch app - no user detected" >> "$LOG_FILE"
fi

# =============================================================================
# Display completion message
# =============================================================================

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "✓ Harbor for Safari has been installed!"
echo ""
echo "Next steps:"
echo "  1. Open Safari → Settings → Extensions"
echo "  2. Enable 'Harbor' and 'Web Agents API'"
echo "  3. Click the ⚓ icon in Safari's toolbar"
echo ""
echo "For local AI: Install Ollama from https://ollama.com"
echo ""
echo "═══════════════════════════════════════════════════════════════"

echo "Post-install completed at $(date)" >> "$LOG_FILE"
exit 0
