#!/bin/bash
# Harbor Safari - Pre-install script
# Checks system requirements before installation

set -e

LOG_FILE="/tmp/harbor-safari-install.log"
echo "Harbor Safari pre-install started at $(date)" > "$LOG_FILE"

# =============================================================================
# Check macOS version
# =============================================================================

echo "Checking system requirements..."

# Get macOS version
OS_VERSION=$(sw_vers -productVersion)
OS_MAJOR=$(echo "$OS_VERSION" | cut -d'.' -f1)
OS_MINOR=$(echo "$OS_VERSION" | cut -d'.' -f2)

echo "  macOS version: $OS_VERSION" >> "$LOG_FILE"

# Require macOS 12.0 or later
if [ "$OS_MAJOR" -lt 12 ]; then
    echo "Error: Harbor requires macOS 12.0 (Monterey) or later."
    echo "       Your version: $OS_VERSION"
    echo "Pre-install failed: macOS $OS_VERSION < 12.0" >> "$LOG_FILE"
    exit 1
fi

echo "  ✓ macOS $OS_VERSION meets requirements"

# =============================================================================
# Check architecture
# =============================================================================

ARCH=$(uname -m)
echo "  Architecture: $ARCH" >> "$LOG_FILE"

if [ "$ARCH" = "arm64" ]; then
    echo "  ✓ Apple Silicon detected"
elif [ "$ARCH" = "x86_64" ]; then
    echo "  ✓ Intel Mac detected"
else
    echo "Warning: Unknown architecture: $ARCH"
    echo "         Installation may not work correctly."
fi

# =============================================================================
# Check for Safari
# =============================================================================

if [ -d "/Applications/Safari.app" ]; then
    SAFARI_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "/Applications/Safari.app/Contents/Info.plist" 2>/dev/null || echo "unknown")
    echo "  Safari version: $SAFARI_VERSION" >> "$LOG_FILE"
    echo "  ✓ Safari found (version $SAFARI_VERSION)"
else
    echo "Warning: Safari not found in /Applications"
    echo "         Harbor requires Safari to function."
fi

# =============================================================================
# Check for existing installation
# =============================================================================

if [ -d "/Applications/Harbor.app" ]; then
    EXISTING_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "/Applications/Harbor.app/Contents/Info.plist" 2>/dev/null || echo "unknown")
    echo "  Existing Harbor version: $EXISTING_VERSION" >> "$LOG_FILE"
    echo "  Note: Existing Harbor installation found (version $EXISTING_VERSION)"
    echo "        It will be upgraded."
fi

# =============================================================================
# Optional: Check for Ollama
# =============================================================================

if command -v ollama &> /dev/null || [ -d "/Applications/Ollama.app" ]; then
    echo "  ✓ Ollama detected (local AI available)"
else
    echo "  Note: Ollama not found. Install from https://ollama.com for local AI."
fi

echo ""
echo "System requirements check passed."
echo "Pre-install completed at $(date)" >> "$LOG_FILE"

exit 0
